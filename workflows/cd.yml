name: 'Continuous Delivery'


on:
 push:
   branches:
     - main


jobs:
 build-and-deploy:
   runs-on: ubuntu-latest


   steps:
     - name: Checkout code
       uses: actions/checkout@v4


     - name: Authenticate to Google Cloud
       uses: google-github-actions/auth@v2
       with:
         credentials_json: ${{ secrets.GCP_SA_KEY }}


     - name: Set up Cloud SDK
       uses: google-github-actions/setup-gcloud@v2


     - name: Configure Docker for Artifact Registry
       run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev --quiet


     - name: Build Docker image
       run: |
         docker build -t ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.GCP_REPOSITORY }}/${{ vars.GCP_SERVICE }}:${{ github.sha }} .
        docker tag ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.GCP_REPOSITORY }}/${{ vars.GCP_SERVICE }}:${{ github.sha }} ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.GCP_REPOSITORY }}/${{ vars.GCP_SERVICE }}:latest


     - name: Push Docker image
       run: |
         docker push ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.GCP_REPOSITORY }}/${{ vars.GCP_SERVICE }}:${{ github.sha }}
        docker push ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.GCP_REPOSITORY }}/${{ vars.GCP_SERVICE }}:latest


     - name: Deploy to Cloud Run
       run: |
         gcloud run deploy ${{ vars.GCP_SERVICE }} \
          --image ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.GCP_REPOSITORY }}/${{ vars.GCP_SERVICE }}:latest \
          --region ${{ vars.GCP_REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --port 8080


